<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia - Painel Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.5em;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .tab-btn.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            background: #fff9f9;
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #ff5252;
        }

        .users-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-item:hover {
            background: #f9f9f9;
        }

        .user-item.selected {
            background: #fff3f3;
            border-left: 4px solid #ff6b6b;
        }

        .user-info {
            flex: 1;
        }

        .user-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #666;
            font-size: 0.9em;
        }

        .exercises-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .exercise-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .exercise-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .exercise-meta {
            font-size: 0.9em;
            color: #666;
        }

        .exercise-meta p {
            margin: 5px 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 10px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .training-group {
            margin-bottom: 25px;
        }

        .training-group h3 {
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ff6b6b;
        }

        .training-exercise {
            background: #f9f9f9;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ff6b6b;
        }

        .exercise-details {
            flex: 1;
        }

        .exercise-details p {
            margin: 3px 0;
            font-size: 0.9em;
            color: #666;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .add-exercise-form {
            background: #f0f8f4;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #4caf50;
        }

        .add-exercise-form h4 {
            color: #333;
            margin-bottom: 12px;
        }

        .exercise-select {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .exercise-option {
            padding: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .exercise-option:hover {
            border-color: #ff6b6b;
            background: #fff9f9;
        }

        .exercise-option.selected {
            border-color: #ff6b6b;
            background: #fff0f0;
        }

        .exercise-option h4 {
            color: #333;
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .exercise-option p {
            color: #666;
            font-size: 0.85em;
            margin: 2px 0;
        }
    </style>

    <!-- Firebase Scripts - VersÃ£o Compat (mais confiÃ¡vel) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    
    <!-- Script inline para aguardar Firebase -->
    <script>
        // Flag para Firebase
        let firebaseScriptsLoaded = false;
        let firebaseLoadAttempts = 0;
        
        // Aguardar Firebase estar disponÃ­vel
        const waitForFirebase = setInterval(() => {
            firebaseLoadAttempts++;
            console.log(`ğŸ” Tentativa ${firebaseLoadAttempts}: firebase = ${typeof firebase}, firebase.database = ${typeof firebase?.database}`);
            
            if (typeof firebase !== 'undefined' && typeof firebase.database === 'function') {
                console.log('âœ… Firebase scripts carregados com sucesso!');
                firebaseScriptsLoaded = true;
                clearInterval(waitForFirebase);
            } else if (firebaseLoadAttempts > 50) {
                console.error('âŒ Timeout ao aguardar Firebase');
                clearInterval(waitForFirebase);
            }
        }, 200);
    </script>
</head>
<body>
    <div class="header">
        <h1>ğŸ”‘ Painel de AdministraÃ§Ã£o</h1>
        <button class="btn-logout" onclick="handleAdminLogout()">ğŸšª Sair</button>
    </div>

    <div class="container">
        <!-- Abas -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('usuarios')">ğŸ‘¥ UsuÃ¡rios</button>
            <button class="tab-btn" onclick="switchTab('exercicios')">ğŸ’ª ExercÃ­cios</button>
            <button class="tab-btn" onclick="switchTab('treinos')">ğŸ“… Treinos</button>
            <button class="tab-btn" onclick="switchTab('historico')">ğŸ“Š HistÃ³rico</button>
        </div>

        <!-- Tab: UsuÃ¡rios -->
        <div id="usuarios" class="tab-content active">
            <h2>Gerenciar UsuÃ¡rios</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn-primary" onclick="openUserModal()">+ Novo UsuÃ¡rio</button>
                <button class="btn-secondary" onclick="syncAllUsersToFirebase()" style="background: #4CAF50;">
                    ğŸ”„ Sincronizar Firebase
                </button>
                <button class="btn-secondary" onclick="testFirebaseConnection()" style="background: #ff9800;">
                    ğŸ”§ Testar Firebase
                </button>
            </div>
            
            <div style="padding: 10px; background: #f0f0f0; border-radius: 6px; margin-bottom: 15px; display: none;" id="firebaseStatus">
                <p id="firebaseStatusText">â³ Verificando Firebase...</p>
            </div>
            
            <div class="success-message" id="successMsg"></div>
            <div class="error-message" id="errorMsg"></div>

            <div class="users-list" id="usersList"></div>
        </div>

        <!-- Tab: ExercÃ­cios -->
        <div id="exercicios" class="tab-content">
            <h2>Gerenciar ExercÃ­cios</h2>
            <button class="btn-primary" onclick="openExerciseModal()">+ Novo ExercÃ­cio</button>
            
            <div class="exercises-grid" id="exercisesList"></div>
        </div>

        <!-- Tab: Treinos -->
        <div id="treinos" class="tab-content">
            <h2>Gerenciar Treinos dos UsuÃ¡rios</h2>
            <p style="color: #666; margin-bottom: 20px;">Clique em um usuÃ¡rio para editar seu treino.</p>
            
            <div class="users-list" id="usersForTraining"></div>
            <div id="trainingPanel" style="margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); display: none;"></div>
        </div>

        <!-- Tab: HistÃ³rico -->
        <div id="historico" class="tab-content">
            <h2>HistÃ³rico de Treinos</h2>
            <p style="color: #666; margin-bottom: 20px;">Visualize o histÃ³rico de treinos de cada usuÃ¡rio.</p>
            
            <div style="margin-bottom: 20px;">
                <label style="font-weight: 600; color: #333; display: block; margin-bottom: 10px;">Selecione um UsuÃ¡rio:</label>
                <select id="userHistorySelect" onchange="loadUserHistory(this.value)" style="width: 100%; max-width: 400px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
                    <option value="">-- Selecione um usuÃ¡rio --</option>
                </select>
            </div>
            
            <div id="historyPanel" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"></div>
        </div>
    </div>

    <!-- Modal UsuÃ¡rio -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="position: relative;">
            <button class="close-modal" onclick="closeUserModal()">Ã—</button>
            <div class="modal-header">Novo UsuÃ¡rio</div>
            <form onsubmit="saveUser(event)">
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label>Nome de UsuÃ¡rio</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div class="form-group">
                    <label>Rotina</label>
                    <input type="text" id="userRoutine" placeholder="Ex: PPL 1 NOVO">
                </div>
                <div class="form-group">
                    <label>Objetivo</label>
                    <input type="text" id="userGoal" placeholder="Ex: Ganho de Massa">
                </div>
                <button type="submit" class="btn-primary">Salvar UsuÃ¡rio</button>
            </form>
        </div>
    </div>

    <!-- Modal ExercÃ­cio -->
    <div id="exerciseModal" class="modal">
        <div class="modal-content" style="position: relative;">
            <button class="close-modal" onclick="closeExerciseModal()">Ã—</button>
            <div class="modal-header">Novo ExercÃ­cio</div>
            <form onsubmit="saveExercise(event)">
                <div class="form-group">
                    <label>Nome do ExercÃ­cio</label>
                    <input type="text" id="exerciseName" required>
                </div>
                <div class="form-group">
                    <label>Grupo Muscular</label>
                    <select id="exerciseGroup" required>
                        <option value="">Selecione...</option>
                        <option value="push">Push</option>
                        <option value="pull">Pull</option>
                        <option value="legs">Legs</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>SÃ©ries</label>
                    <input type="text" id="exerciseSeries" placeholder="Ex: 3x12">
                </div>
                <div class="form-group">
                    <label>Carga</label>
                    <input type="text" id="exerciseLoad" placeholder="Ex: 10kg">
                </div>
                <div class="form-group">
                    <label>Intervalo</label>
                    <input type="text" id="exerciseInterval" placeholder="Ex: 50s">
                </div>
                <div class="form-group">
                    <label>InstruÃ§Ãµes</label>
                    <textarea id="exerciseInstructions" rows="4"></textarea>
                </div>
                <button type="submit" class="btn-primary">Salvar ExercÃ­cio</button>
            </form>
        </div>
    </div>

    <script>
        const DEMO_USERS = {
            'Leandro': {
                password: '123456',
                id: 1,
                name: 'Leandro Barba',
                routine: 'PPL 1 NOVO',
                goal: 'ReduÃ§Ã£o de gordura/Hipertrofia - IntermediÃ¡rio'
            },
            'JoÃ£o': {
                password: 'senha123',
                id: 2,
                name: 'JoÃ£o Silva',
                routine: 'Full Body',
                goal: 'Ganho de Massa'
            },
            'Maria': {
                password: 'senha123',
                id: 3,
                name: 'Maria Santos',
                routine: 'ABCD',
                goal: 'Ganho de Massa'
            }
        };

        let allUsers = { ...DEMO_USERS };
        let selectedUser = null;

        // ExercÃ­cios de demo - COMPLETA BIBLIOTECA COM 19 EXERCÃCIOS
        const DEMO_EXERCISES = {
            // PUSH (10 exercÃ­cios)
            1: { name: 'Supino reto barra', grupo: 'push', series: '3x12 drop set', load: '80kg', interval: '50s', instructions: 'Drop set na Ãºltima sÃ©rie', id: 1 },
            2: { name: 'Supino inclinado 30 halteres', grupo: 'push', series: '3x10/10/6', load: '20kg', interval: '50s', instructions: 'Progressivo em carga', id: 2 },
            3: { name: 'Crucifixo Fly ou PecDeck mÃ¡quina', grupo: 'push', series: '3x12', load: '40kg', interval: '45s', instructions: 'Movimento controlado', id: 3 },
            4: { name: 'Crucifixo polia alta', grupo: 'push', series: '1x25', load: '25kg', interval: '50s', instructions: 'SÃ©rie Ãºnica com bastante volume', id: 4 },
            5: { name: 'Desenvolvimento mÃ¡quina', grupo: 'push', series: '4x12', load: '60kg', interval: '50s', instructions: 'Cotovelos nunca trancam', id: 5 },
            6: { name: 'TrÃ­ceps francÃªs barra polia baixa', grupo: 'push', series: '4x12', load: '40kg', interval: '50s', instructions: 'Cotovelos fixos, estenda completamente', id: 6 },
            7: { name: 'TrÃ­ceps francÃªs corda polia baixa', grupo: 'push', series: '3x12-15', load: '35kg', interval: '45s', instructions: 'Puxe a corda em direÃ§Ã£o Ã s coxas', id: 7 },
            8: { name: 'Pulley trÃ­ceps barra reta', grupo: 'push', series: '3x12-15', load: '30kg', interval: '45s', instructions: 'Palmas para baixo, cotovelos fixos', id: 8 },
            9: { name: 'Pulley trÃ­ceps supinado', grupo: 'push', series: '3x12-15', load: '25kg', interval: '45s', instructions: 'Palmas para cima, movimento controlado', id: 9 },
            10: { name: 'TrÃ­ceps pulley corda', grupo: 'push', series: '3x12-15', load: '35kg', interval: '45s', instructions: 'Afaste a corda no final do movimento', id: 10 },
            
            // PULL (6 exercÃ­cios)
            11: { name: 'Puxada frontal aberta', grupo: 'pull', series: '4x8-10', load: '80kg', interval: '60s', instructions: 'Puxe atÃ© o peito, puxe com escÃ¡pula', id: 11 },
            12: { name: 'Puxada frontal aberta (variaÃ§Ã£o)', grupo: 'pull', series: '4x8-10', load: '75kg', interval: '60s', instructions: 'Pegada mais fechada, puxe atÃ© queixo', id: 12 },
            13: { name: 'Remada sentada mÃ¡quina', grupo: 'pull', series: '4x10-12', load: '90kg', interval: '60s', instructions: 'Costas eretas, puxe para abdÃ´men', id: 13 },
            14: { name: 'Rosca em PÃ© Halteres', grupo: 'pull', series: '3x8-10', load: '18kg', interval: '60s', instructions: 'Cotovelos fixos, sem balanÃ§ar corpo', id: 14 },
            15: { name: 'Rosca BÃ­ceps Halteres', grupo: 'pull', series: '3x8-10', load: '18kg', interval: '60s', instructions: 'Movimento alternado ou simultÃ¢neo', id: 15 },
            16: { name: 'Rosca Direta em PÃ© Polia baixa', grupo: 'pull', series: '3x10-12', load: '35kg', interval: '50s', instructions: 'Cotovelos fixos, movimento controlado', id: 16 },
            
            // LEGS (3 exercÃ­cios)
            17: { name: 'Agachamento Livre', grupo: 'legs', series: '4x8-10', load: '120kg', interval: '90s', instructions: 'Profundidade atÃ© paralelo, peito para cima', id: 17 },
            18: { name: 'Legpress Horizontal', grupo: 'legs', series: '4x8-10', load: '280kg', interval: '60s', instructions: 'PÃ©s afastados, nÃ£o tranque joelhos', id: 18 },
            19: { name: 'Cadeira Adutora', grupo: 'legs', series: '3x12-15', load: '80kg', interval: '45s', instructions: 'Aduto as coxas completamente', id: 19 }
        };

        function checkAdminLogin() {
            if (!localStorage.getItem('adminUser')) {
                window.location.href = 'admin-login.html';
            }
        }

        // VariÃ¡veis globais para Firebase
        let db = null;
        let firebaseReady = false;

        // Inicializar Firebase no admin
        function initializeFirebaseAdmin() {
            try {
                console.log('ğŸ”„ Inicializando Firebase...');
                console.log('typeof firebase:', typeof firebase);
                console.log('firebaseScriptsLoaded:', firebaseScriptsLoaded);
                console.log('firebase.database:', typeof firebase?.database);
                
                if (typeof firebase === 'undefined' || !firebaseScriptsLoaded || typeof firebase.database !== 'function') {
                    console.warn('âš ï¸ Firebase SDK ainda nÃ£o carregou. Aguardando... (tentativa contÃ­nua)');
                    setTimeout(initializeFirebaseAdmin, 1000);
                    return;
                }

                const firebaseConfig = {
                    apiKey: "AIzaSyB5CPHE4fvlkZYa0KkINr-NlhIMPYs4qAM",
                    authDomain: "academiatreinoapp-d2004.firebaseapp.com",
                    databaseURL: "https://academiatreinoapp-d2004-default-rtdb.firebaseio.com",
                    projectId: "academiatreinoapp-d2004",
                    storageBucket: "academiatreinoapp-d2004.firebasestorage.app",
                    messagingSenderId: "1075985055185",
                    appId: "1:1075985055185:web:bdaf8c84c4778361e974f0",
                    measurementId: "G-8TVK5XD653"
                };

                // Evitar reinicializar se jÃ¡ foi inicializado
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('âœ… Firebase app inicializado com sucesso!');
                }
                
                db = firebase.database();
                firebaseReady = true;
                console.log('âœ…âœ…âœ… FIREBASE ESTÃ PRONTO! âœ…âœ…âœ…');
                console.log('ğŸ”¥ Database URL:', firebaseConfig.databaseURL);
                console.log('ğŸ“Š db =', db);
            } catch (error) {
                console.error('âŒ Erro ao inicializar Firebase:', error.message);
                console.error('Stack:', error.stack);
                setTimeout(initializeFirebaseAdmin, 2000);
            }
        }

        function handleAdminLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('adminUser');
                window.location.href = 'admin-login.html';
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'usuarios') loadUsers();
            if (tabName === 'exercicios') loadExercises();
            if (tabName === 'treinos') loadUsersForTraining();
            if (tabName === 'historico') loadHistoricoTab();
        }

        function loadUsers() {
            console.log('ğŸ‘¥ Carregando usuÃ¡rios...');
            console.log('allUsers:', allUsers);
            
            const usersList = document.getElementById('usersList');
            const usersCount = Object.keys(allUsers).length;
            console.log(`ğŸ“Š Total de usuÃ¡rios: ${usersCount}`);
            
            if (usersCount === 0) {
                usersList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Nenhum usuÃ¡rio criado ainda</p>';
                return;
            }
            
            usersList.innerHTML = Object.entries(allUsers).map(([username, user]) => `
                <div class="user-item">
                    <div class="user-info">
                        <h3>${user.name}</h3>
                        <p>UsuÃ¡rio: ${username}</p>
                        <p>Rotina: ${user.routine}</p>
                        <p>Objetivo: ${user.goal}</p>
                    </div>
                </div>
            `).join('');
            
            console.log('âœ… UsuÃ¡rios carregados com sucesso');
        }

        function loadExercises() {
            let exercises = JSON.parse(localStorage.getItem('allExercises'));
            
            // Se nÃ£o houver exercÃ­cios, usa os de demo
            if (!exercises || Object.keys(exercises).length === 0) {
                exercises = DEMO_EXERCISES;
                localStorage.setItem('allExercises', JSON.stringify(exercises));
            }
            
            const exercisesList = document.getElementById('exercisesList');
            
            if (Object.keys(exercises).length === 0) {
                exercisesList.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Nenhum exercÃ­cio cadastrado ainda.</p>';
                return;
            }

            // Agrupar exercÃ­cios por categoria
            const grouped = {
                push: [],
                pull: [],
                legs: []
            };
            
            Object.entries(exercises).forEach(([id, ex]) => {
                if (grouped[ex.grupo]) {
                    grouped[ex.grupo].push([id, ex]);
                }
            });

            // Renderizar por grupos
            let html = '';
            const groupIcons = { push: 'ğŸ’ª', pull: 'ğŸ”™', legs: 'ğŸ¦µ' };
            const groupNames = { push: 'Push (Peito, Ombro, TrÃ­ceps)', pull: 'Pull (Costas, BÃ­ceps)', legs: 'Legs (Pernas)' };
            
            Object.entries(grouped).forEach(([group, items]) => {
                if (items.length > 0) {
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #ff6b6b; margin-bottom: 15px; font-size: 1.2em;">
                                ${groupIcons[group]} ${groupNames[group]} (${items.length} exercÃ­cios)
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                    `;
                    
                    items.forEach(([id, ex]) => {
                        html += `
                            <div class="exercise-card" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ff6b6b;">
                                <h4 style="color: #333; margin-bottom: 10px;">${ex.name}</h4>
                                <div class="exercise-meta" style="font-size: 0.9em;">
                                    <p><strong>SÃ©ries:</strong> ${ex.series}</p>
                                    <p><strong>Carga:</strong> ${ex.load}</p>
                                    <p><strong>Intervalo:</strong> ${ex.interval}</p>
                                    <p style="margin-top: 8px; color: #666; font-size: 0.85em; font-style: italic;">${ex.instructions}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            exercisesList.innerHTML = html;
        }

        function openUserModal() {
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            document.getElementById('userName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRoutine').value = '';
            document.getElementById('userGoal').value = '';
        }

        function saveUser(event) {
            event.preventDefault();
            console.log('ğŸ“ Tentando salvar novo usuÃ¡rio...');
            
            const name = document.getElementById('userName').value;
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const routine = document.getElementById('userRoutine').value;
            const goal = document.getElementById('userGoal').value;

            console.log('Dados coletados:', { name, username, password, routine, goal });

            // ValidaÃ§Ãµes
            if (!name || !username || !password || !routine || !goal) {
                alert('âŒ Preencha todos os campos!');
                console.error('âŒ Campos faltando:', { name, username, password, routine, goal });
                return;
            }

            if (allUsers[username]) {
                alert('âŒ Este nome de usuÃ¡rio jÃ¡ existe!');
                console.warn('âš ï¸ UsuÃ¡rio jÃ¡ existe:', username);
                return;
            }

            try {
                const newId = Math.max(...Object.values(allUsers).map(u => u.id), 0) + 1;
                const newUser = { name, password, id: newId, routine, goal };
                console.log('âœ… Novo usuÃ¡rio criado:', newUser);
                
                allUsers[username] = newUser;

                // Salvar no localStorage
                localStorage.setItem('allUsers', JSON.stringify(allUsers));
                console.log('âœ… UsuÃ¡rio salvo em localStorage:', username);
                
                // Salvar no Firebase
                console.log('ğŸ“¤ Chamando saveUserToFirebase...');
                saveUserToFirebase(username, newUser);

                showSuccess('âœ… UsuÃ¡rio criado com sucesso! (salvo localmente e em nuvem)');
                closeUserModal();
                loadUsers();
            } catch (error) {
                console.error('âŒ Erro ao salvar usuÃ¡rio:', error);
                alert('âŒ Erro ao salvar: ' + error.message);
            }
        }

        // Salvar usuÃ¡rio no Firebase
        function saveUserToFirebase(username, userData) {
            console.log('ğŸ”¥ saveUserToFirebase chamado para:', username);
            console.log('firebaseReady:', firebaseReady, '| db:', db ? 'existe' : 'null');
            
            if (!firebaseReady || !db) {
                console.warn('âš ï¸ Firebase nÃ£o disponÃ­vel, usuÃ¡rio salvo apenas em localStorage');
                console.warn('Tentando novamente em 1s...');
                setTimeout(() => saveUserToFirebase(username, userData), 1000);
                return;
            }

            try {
                const path = `usuarios/${username}`;
                console.log('ğŸ“¤ Salvando usuÃ¡rio em Firebase:', path);
                console.log('ğŸ“Š Dados:', userData);
                
                db.ref(path).set(userData)
                    .then(() => {
                        console.log('âœ…âœ… UsuÃ¡rio salvo com SUCESSO no Firebase:', username);
                    })
                    .catch(error => {
                        console.error('âŒ Erro ao salvar em Firebase:', error.code, error.message);
                        console.error('Detalhes do erro:', error);
                    });
            } catch (error) {
                console.error('âŒ Erro crÃ­tico ao salvar usuÃ¡rio:', error.message);
            }
        }

        // Sincronizar todos os usuÃ¡rios com Firebase
        function syncAllUsersToFirebase() {
            if (!firebaseReady || !db) {
                console.warn('âš ï¸ Firebase nÃ£o disponÃ­vel');
                alert('âš ï¸ Firebase nÃ£o estÃ¡ inicializado. Tente atualizar a pÃ¡gina.');
                return;
            }

            let syncedCount = 0;
            Object.entries(allUsers).forEach(([username, userData]) => {
                saveUserToFirebase(username, userData);
                syncedCount++;
            });
            
            console.log(`âœ… ${syncedCount} usuÃ¡rios sincronizados com Firebase!`);
            alert(`âœ… ${syncedCount} usuÃ¡rios sincronizados com sucesso!`);
        }

        // ğŸ”§ Testar conexÃ£o com Firebase
        function testFirebaseConnection() {
            const statusDiv = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            
            statusDiv.style.display = 'block';
            statusText.innerHTML = 'â³ Testando conexÃ£o com Firebase...';
            
            console.log('=== TESTE DE CONEXÃƒO FIREBASE ===');
            console.log('firebaseReady:', firebaseReady);
            console.log('db:', db ? 'âœ… Existe' : 'âŒ NÃ£o existe');
            console.log('typeof firebase:', typeof firebase);
            
            if (!firebaseReady || !db) {
                statusText.innerHTML = `
                    âŒ <strong>Firebase nÃ£o inicializado!</strong><br>
                    firebaseReady: ${firebaseReady}<br>
                    db: ${db ? 'existe' : 'null'}<br>
                    <small>Atualize a pÃ¡gina e tente novamente</small>
                `;
                alert('âŒ Firebase nÃ£o estÃ¡ inicializado. Atualize a pÃ¡gina.');
                return;
            }
            
            // Tentar escrever um teste
            const testRef = db.ref('admin-test/connection-check');
            const testData = {
                timestamp: new Date().toISOString(),
                test: true
            };
            
            testRef.set(testData)
                .then(() => {
                    console.log('âœ… Teste de escrita bem-sucedido');
                    statusText.innerHTML = `
                        âœ… <strong>ConexÃ£o Firebase OK!</strong><br>
                        â€¢ Firebase: ${firebaseReady ? 'âœ… Inicializado' : 'âŒ NÃ£o'}<br>
                        â€¢ Database: ${db ? 'âœ… Conectado' : 'âŒ NÃ£o'}<br>
                        â€¢ Escrita: âœ… Funcionando<br>
                        <small>Dados sincronizados com sucesso</small>
                    `;
                    alert('âœ… Firebase estÃ¡ funcionando corretamente!');
                })
                .catch(error => {
                    console.error('âŒ Erro no teste:', error);
                    statusText.innerHTML = `
                        âŒ <strong>Erro na conexÃ£o!</strong><br>
                        CÃ³digo: ${error.code}<br>
                        Mensagem: ${error.message}<br>
                        <small style="color: #d32f2f;">Verifique as regras de seguranÃ§a do Firebase</small>
                    `;
                    alert(`âŒ Erro ao conectar com Firebase: ${error.message}`);
                });
        }

        // ğŸ”¥ Sincronizar treino do usuÃ¡rio com Firebase
        function saveTrainingToFirebase(username, trainingData, retryCount = 0) {
            const MAX_RETRIES = 5;
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ”¥ SINCRONIZANDO TREINO COM FIREBASE');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`Tentativa: ${retryCount + 1}/${MAX_RETRIES + 1}`);
            console.log('ğŸ‘¤ UsuÃ¡rio:', username);
            console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            console.log('ğŸ”¥ Status Firebase:');
            console.log('  â€¢ firebaseReady:', firebaseReady);
            console.log('  â€¢ db existe:', db ? 'SIM' : 'NÃƒO');
            console.log('  â€¢ typeof firebase:', typeof firebase);
            console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            if (!firebaseReady || !db) {
                console.warn(`âš ï¸ Firebase nÃ£o pronto!`);
                console.warn(`   firebaseReady=${firebaseReady}`);
                console.warn(`   db=${db ? 'existe' : 'null'}`);
                
                if (retryCount < MAX_RETRIES) {
                    console.log(`ğŸ”„ Tentando novamente em 1s... (Tentativa ${retryCount + 2}/${MAX_RETRIES + 1})`);
                    setTimeout(() => {
                        saveTrainingToFirebase(username, trainingData, retryCount + 1);
                    }, 1000);
                } else {
                    console.error('âŒâŒ FALHA APÃ“S MÃšLTIPLAS TENTATIVAS!');
                    console.error('âš ï¸ Treino salvo APENAS em localStorage!');
                }
                return;
            }

            try {
                const path = `usuarios/${username}/treinos`;
                console.log(`ğŸ“¤ Sincronizando em:`, path);
                console.log('ğŸ“Š Dados a sincronizar:', JSON.stringify(trainingData, null, 2));
                
                db.ref(path).set(trainingData)
                    .then(() => {
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('âœ…âœ…âœ… TREINO SINCRONIZADO COM SUCESSO! âœ…âœ…âœ…');
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('ğŸ“ LocalizaÃ§Ã£o:', path);
                        console.log('ğŸ“Š Dados:', trainingData);
                    })
                    .catch(error => {
                        console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.error('âŒ ERRO AO SINCRONIZAR TREINO!');
                        console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.error('CÃ³digo de erro:', error.code);
                        console.error('Mensagem:', error.message);
                        console.error('Objeto completo:', error);
                        
                        // Tentar novamente se for erro de rede
                        if ((error.code === 'NETWORK_ERROR' || error.message?.includes('NETWORK')) && retryCount < MAX_RETRIES) {
                            console.log('ğŸ”„ Erro de rede, tentando novamente...');
                            setTimeout(() => {
                                saveTrainingToFirebase(username, trainingData, retryCount + 1);
                            }, 2000);
                        }
                    });
            } catch (error) {
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ ERRO CRÃTICO NA SINCRONIZAÃ‡ÃƒO!');
                console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('Mensagem:', error.message);
                console.error('Stack:', error.stack);
            }
        }

        function saveExerciseCustomization(username, exerciseId, series, load) {
            console.log(`ğŸ’¾ Salvando customizaÃ§Ã£o do exercÃ­cio ${exerciseId} para ${username}`);
            console.log(`ğŸ“‹ SÃ©ries: ${series}, Carga: ${load}`);
            
            let customTraining = JSON.parse(localStorage.getItem(`custom_training_${username}`)) || {};
            customTraining[exerciseId] = {
                series: series.trim() || 'N/A',
                load: load.trim() || 'N/A'
            };
            
            localStorage.setItem(`custom_training_${username}`, JSON.stringify(customTraining));
            console.log('âœ… CustomizaÃ§Ã£o salva em localStorage');
            
            // ğŸ”¥ Sincronizar com Firebase
            saveTrainingToFirebase(username, customTraining);
            
            showSuccess('Carga e repetiÃ§Ãµes atualizadas com sucesso!');
            loadUserTraining();
        }

        function removeExerciseFromTraining(username, grupo, exerciseId) {
            if (confirm('Tem certeza que deseja remover este exercÃ­cio?')) {
                let userTraining = JSON.parse(localStorage.getItem(`training_${username}`)) || {};
                if (userTraining[grupo]) {
                    userTraining[grupo] = userTraining[grupo].filter(id => id !== parseInt(exerciseId));
                    localStorage.setItem(`training_${username}`, JSON.stringify(userTraining));
                    console.log('âœ… ExercÃ­cio removido de localStorage');
                    
                    // ğŸ”¥ Sincronizar com Firebase
                    saveTrainingToFirebase(username, userTraining);
                    
                    showSuccess('ExercÃ­cio removido com sucesso!');
                    loadUserTraining();
                }
            }
        }

        function openExerciseModal() {
            document.getElementById('exerciseModal').classList.add('active');
        }

        function closeExerciseModal() {
            document.getElementById('exerciseModal').classList.remove('active');
        }

        function saveExercise(event) {
            event.preventDefault();

            const name = document.getElementById('exerciseName').value;
            const grupo = document.getElementById('exerciseGroup').value;
            const series = document.getElementById('exerciseSeries').value;
            const load = document.getElementById('exerciseLoad').value;
            const interval = document.getElementById('exerciseInterval').value;
            const instructions = document.getElementById('exerciseInstructions').value;

            let exercises = JSON.parse(localStorage.getItem('allExercises')) || {};
            const newId = Math.max(...Object.keys(exercises).map(Number), 0) + 1;

            exercises[newId] = { name, grupo, series, load, interval, instructions, id: newId };
            localStorage.setItem('allExercises', JSON.stringify(exercises));

            showSuccess('ExercÃ­cio criado com sucesso!');
            closeExerciseModal();
            loadExercises();
        }

        function loadUsersForTraining() {
            const usersList = document.getElementById('usersForTraining');
            usersList.innerHTML = Object.entries(allUsers).map(([username, user]) => `
                <div class="user-item" onclick="selectUserForTraining('${username}')">
                    <div class="user-info">
                        <h3>${user.name}</h3>
                        <p>UsuÃ¡rio: ${username}</p>
                    </div>
                </div>
            `).join('');
        }

        function selectUserForTraining(username) {
            selectedUser = username;
            document.querySelectorAll('#usersForTraining .user-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            loadUserTraining();
        }

        function loadUserTraining() {
            if (!selectedUser) return;

            const panel = document.getElementById('trainingPanel');
            let allExercises = JSON.parse(localStorage.getItem('allExercises'));
            
            // Se nÃ£o houver exercÃ­cios salvos, usa os de demo
            if (!allExercises || Object.keys(allExercises).length === 0) {
                allExercises = DEMO_EXERCISES;
                localStorage.setItem('allExercises', JSON.stringify(DEMO_EXERCISES));
            }
            
            const userTraining = JSON.parse(localStorage.getItem(`training_${selectedUser}`)) || {};

            panel.style.display = 'block';

            let html = `<h3>ğŸ“… Treino de ${allUsers[selectedUser].name}</h3>`;

            ['push', 'pull', 'legs'].forEach(grupo => {
                const groupExercises = Object.entries(allExercises).filter(([id, ex]) => ex.grupo === grupo);
                const userGroupExercises = userTraining[grupo] || [];

                html += `<div class="training-group">
                    <h3>${grupo === 'push' ? 'ğŸ’ª Push' : grupo === 'pull' ? 'ğŸ”™ Pull' : 'ğŸ¦µ Legs'}</h3>`;

                if (userGroupExercises.length > 0) {
                    html += userGroupExercises.map(exId => {
                        const ex = allExercises[exId];
                        if (!ex) return '';
                        
                        // Carrega valores customizados ou usa os padrÃµes
                        let customTraining = JSON.parse(localStorage.getItem(`custom_training_${selectedUser}`)) || {};
                        let userExerciseData = customTraining[exId] || { series: ex.series, load: ex.load };
                        
                        return `
                            <div class="training-exercise">
                                <div class="exercise-details">
                                    <p><strong>${ex.name}</strong></p>
                                    <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div>
                                            <label style="font-size: 0.9em; color: #666;">SÃ©ries/Reps:</label>
                                            <input type="text" id="series_${exId}" value="${userExerciseData.series}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;" placeholder="ex: 3x12">
                                        </div>
                                        <div>
                                            <label style="font-size: 0.9em; color: #666;">Carga:</label>
                                            <input type="text" id="load_${exId}" value="${userExerciseData.load}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;" placeholder="ex: 10kg">
                                        </div>
                                    </div>
                                    <p style="font-size: 0.85em; color: #999; margin-top: 5px;">Intervalo: ${ex.interval}</p>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn-primary" onclick="saveExerciseCustomization('${selectedUser}', ${exId}, document.getElementById('series_${exId}').value, document.getElementById('load_${exId}').value)" style="flex: 1; padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ“ Salvar</button>
                                    <button class="btn-danger" onclick="removeExerciseFromTraining('${selectedUser}', '${grupo}', ${exId})" style="flex: 1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">âœ• Remover</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    html += `<p style="color: #999; font-style: italic;">Nenhum exercÃ­cio atribuÃ­do</p>`;
                }

                // FormulÃ¡rio para adicionar exercÃ­cios
                const availableExercises = groupExercises.filter(([id]) => !userGroupExercises.includes(parseInt(id)));
                
                if (availableExercises.length > 0) {
                    html += `
                        <div class="add-exercise-form">
                            <h4>âœ¨ Adicionar ExercÃ­cio (${availableExercises.length} disponÃ­veis)</h4>
                            <div class="exercise-select">
                                ${availableExercises.map(([id, ex]) => `
                                    <div class="exercise-option" onclick="addExerciseToTraining('${selectedUser}', '${grupo}', ${id})" style="padding: 12px; background: white; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;">
                                        <h4 style="color: #333; font-size: 0.95em; margin-bottom: 8px; font-weight: 600;">${ex.name}</h4>
                                        <div style="font-size: 0.85em; color: #666;">
                                            <p>ğŸ“‹ SÃ©ries: <strong>${ex.series}</strong></p>
                                            <p>âš–ï¸ Carga: <strong>${ex.load}</strong></p>
                                            <p>â±ï¸ Intervalo: <strong>${ex.interval}</strong></p>
                                            ${ex.instructions ? `<p style="margin-top: 5px; color: #999; font-size: 0.8em; font-style: italic;">ğŸ’¡ ${ex.instructions}</p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
            });

            panel.innerHTML = html;
        }

        function addExerciseToTraining(username, grupo, exerciseId) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“Œ ADICIONANDO EXERCÃCIO AO TREINO');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ‘¤ UsuÃ¡rio:', username);
            console.log('ğŸ’ª Grupo:', grupo);
            console.log('ğŸ‹ï¸ ExercÃ­cio ID:', exerciseId);
            console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            // Verificar Firebase
            console.log('ğŸ”¥ Status Firebase:');
            console.log('  â€¢ firebaseReady:', firebaseReady);
            console.log('  â€¢ db existe:', db ? 'SIM' : 'NÃƒO');
            
            try {
                let userTraining = JSON.parse(localStorage.getItem(`training_${username}`)) || { push: [], pull: [], legs: [] };
                if (!userTraining[grupo]) userTraining[grupo] = [];
                
                console.log('ğŸ“Š Treino atual:', userTraining);
                
                const exId = parseInt(exerciseId);
                
                if (!userTraining[grupo].includes(exId)) {
                    userTraining[grupo].push(exId);
                    
                    console.log('âœ… ExercÃ­cio adicionado ao array local:', userTraining[grupo]);
                    
                    // Salvar em localStorage
                    localStorage.setItem(`training_${username}`, JSON.stringify(userTraining));
                    console.log('âœ… SALVO em localStorage!');
                    
                    // ğŸ”¥ Sincronizar com Firebase
                    console.log('ğŸ“¤ ENVIANDO para Firebase...');
                    saveTrainingToFirebase(username, userTraining);
                    
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    console.log('âœ¨ ExercÃ­cio adicionado com sucesso!');
                    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                    
                    showSuccess('âœ… ExercÃ­cio adicionado com sucesso!');
                    loadUserTraining(); // Recarrega a interface
                } else {
                    console.log('âš ï¸ ExercÃ­cio jÃ¡ existe no treino');
                    alert('âš ï¸ Este exercÃ­cio jÃ¡ estÃ¡ no treino!');
                }
            } catch (error) {
                console.error('âŒ ERRO ao adicionar exercÃ­cio:', error);
                console.error('Stack:', error.stack);
                alert('âŒ Erro: ' + error.message);
            }
        }

        function saveExerciseCustomization(username, exerciseId, series, load) {
            console.log(`ğŸ’¾ Salvando customizaÃ§Ã£o do exercÃ­cio ${exerciseId} para ${username}`);
            console.log(`ğŸ“‹ SÃ©ries: ${series}, Carga: ${load}`);
            
            let customTraining = JSON.parse(localStorage.getItem(`custom_training_${username}`)) || {};
            customTraining[exerciseId] = {
                series: series.trim() || 'N/A',
                load: load.trim() || 'N/A'
            };
            
            localStorage.setItem(`custom_training_${username}`, JSON.stringify(customTraining));
            console.log('âœ… CustomizaÃ§Ã£o salva em localStorage');
            
            // ğŸ”¥ Sincronizar com Firebase
            saveTrainingToFirebase(username, customTraining);
            
            showSuccess('Carga e repetiÃ§Ãµes atualizadas com sucesso!');
            loadUserTraining();
        }

        function removeExerciseFromTraining(username, grupo, exerciseId) {
            if (confirm('Tem certeza que deseja remover este exercÃ­cio?')) {
                let userTraining = JSON.parse(localStorage.getItem(`training_${username}`)) || {};
                if (userTraining[grupo]) {
                    userTraining[grupo] = userTraining[grupo].filter(id => id !== parseInt(exerciseId));
                    localStorage.setItem(`training_${username}`, JSON.stringify(userTraining));
                    console.log('âœ… ExercÃ­cio removido de localStorage');
                    
                    // ğŸ”¥ Sincronizar com Firebase
                    saveTrainingToFirebase(username, userTraining);
                    
                    showSuccess('ExercÃ­cio removido com sucesso!');
                    loadUserTraining();
                }
            }
        }

        function updateUserTraining(username, grupo) {
            const checkboxes = document.querySelectorAll(`input[type="checkbox"][value]`);
            const selectedExercises = Array.from(document.querySelectorAll(`input[type="checkbox"]:checked`))
                .filter(cb => {
                    const ex = JSON.parse(localStorage.getItem('allExercises'))[cb.value];
                    return ex && ex.grupo === grupo;
                })
                .map(cb => parseInt(cb.value));

            let userTraining = JSON.parse(localStorage.getItem(`training_${username}`)) || {};
            userTraining[grupo] = selectedExercises;
            localStorage.setItem(`training_${username}`, JSON.stringify(userTraining));

            showSuccess('Treino atualizado com sucesso!');
        }

        function showSuccess(msg) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = 'âœ… ' + msg;
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        // ============ FUNÃ‡Ã•ES DE HISTÃ“RICO ============

        function loadHistoricoTab() {
            const select = document.getElementById('userHistorySelect');
            select.innerHTML = '<option value="">-- Selecione um usuÃ¡rio --</option>';
            
            Object.entries(allUsers).forEach(([username, user]) => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = user.name;
                select.appendChild(option);
            });
            
            document.getElementById('historyPanel').innerHTML = '<p style="color: #999; text-align: center;">Selecione um usuÃ¡rio para visualizar seu histÃ³rico</p>';
        }

        function loadUserHistory(username) {
            if (!username) {
                document.getElementById('historyPanel').innerHTML = '<p style="color: #999; text-align: center;">Selecione um usuÃ¡rio para visualizar seu histÃ³rico</p>';
                return;
            }

            const storageKey = `training_session_${username}`;
            const sessionData = JSON.parse(localStorage.getItem(storageKey)) || {};
            const customTraining = JSON.parse(localStorage.getItem(`custom_training_${username}`)) || {};
            const allExercises = JSON.parse(localStorage.getItem('allExercises')) || DEMO_EXERCISES;
            
            // Simula histÃ³rico dos Ãºltimos 30 dias (base no localStorage atual)
            const historyPanel = document.getElementById('historyPanel');
            let html = '';
            
            if (!sessionData.date) {
                historyPanel.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Nenhum histÃ³rico de treino para este usuÃ¡rio</p>';
                return;
            }

            // Cria histÃ³rico simulado dos Ãºltimos 7 dias
            const trainingHistory = generateTrainingHistory(username, sessionData, customTraining, allExercises);
            
            if (trainingHistory.length === 0) {
                historyPanel.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Nenhum histÃ³rico de treino para este usuÃ¡rio</p>';
                return;
            }

            html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
            `;

            trainingHistory.forEach(entry => {
                html += `
                    <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; color: #333;">${entry.date}</h4>
                            <span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">âœ“ ConcluÃ­do</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">â±ï¸ Tempo</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #333; font-family: monospace;">${entry.time}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">ğŸ’ª ExercÃ­cios</div>
                                <div style="font-size: 1.3em; font-weight: 700; color: #333;">${entry.exercises}</div>
                            </div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">ğŸ‹ï¸ Carga Total</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: #667eea;">${entry.load}</div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            historyPanel.innerHTML = html;
        }

        function generateTrainingHistory(username, sessionData, customTraining, allExercises) {
            const history = [];
            const exercises = JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEMO_DATA;
            
            // Cria entrada do dia atual se houver dados
            if (sessionData.date && sessionData.elapsedSeconds > 0) {
                const stats = calculateTrainingStats(exercises, customTraining);
                history.push({
                    date: new Date(sessionData.date).toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    }).replace(/^\w/, (c) => c.toUpperCase()),
                    time: formatTime(sessionData.elapsedSeconds),
                    exercises: stats.totalExercises,
                    load: stats.totalLoad
                });
            }

            // Simula dados dos dias anteriores (apenas para visualizaÃ§Ã£o)
            const daysToSimulate = 6;
            for (let i = 1; i < daysToSimulate; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                // Simula treinos aleatoriamente para os Ãºltimos dias
                if (Math.random() > 0.3) {
                    history.push({
                        date: date.toLocaleDateString('pt-BR', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        }).replace(/^\w/, (c) => c.toUpperCase()),
                        time: `${String(Math.floor(Math.random() * 2)).padStart(2, '0')}:${String(Math.floor(Math.random() * 59) + 1).padStart(2, '0')}:${String(Math.floor(Math.random() * 59)).padStart(2, '0')}`,
                        exercises: Math.floor(Math.random() * 5) + 7,
                        load: `${Math.floor(Math.random() * 300) + 200} kg`
                    });
                }
            }

            return history;
        }

        function calculateTrainingStats(exercises, customTraining) {
            let totalExercises = 0;
            let totalLoadValue = 0;
            
            Object.keys(exercises).forEach(group => {
                if (Array.isArray(exercises[group])) {
                    exercises[group].forEach(ex => {
                        if (ex.completed) {
                            totalExercises++;
                            
                            const customLoad = customTraining[ex.id]?.load || ex.load || '0kg';
                            const loadMatch = customLoad.match(/(\d+(?:\.\d+)?)/);
                            if (loadMatch) {
                                totalLoadValue += parseFloat(loadMatch[1]);
                            }
                        }
                    });
                }
            });
            
            return {
                totalExercises: totalExercises,
                totalLoad: `${Math.round(totalLoadValue)} kg`
            };
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        window.addEventListener('load', () => {
            console.log('ğŸ“„ PÃ¡gina carregada, iniciando admin...');
            checkAdminLogin();
            loadUsers();
            
            // Esperar um pouco para Firebase carregar
            setTimeout(() => {
                initializeFirebaseAdmin();
            }, 500);
        });
    </script>
</body>
</html>
